!RunBook
name: Apache Tomcat 8.0 Install RunBook
authors: Divine Cloud Team
description: This run book installs Apache Tomcat version 8.0.22 on linux environments.
hardwareRequirements: Minimum memory of 512 MB or more.
preRequisite: "Following software need to be already installed on the machine before executing this r\
   un book:\n<ul>\n<li>Java 6 or higher</li> \n<li>JAVA_HOME should be set</li>\n<li>yum or apt-get p\
   ackage manager</li>\n<li>wget utility for downloading tomcat binaries.</li>\n</ul>"
steps: 
-  name: Existing Tomcat Server Cleanup
   item: !ScriptItem
      description: This step verifies if the provided target location has any files in it. If it does,
         it deletes those file, for a clean installation of tomcat server.
      fileName: 
      invokingProgram: 
      language: Shell
      script: "echo \"Stopping the existing tomcat process if running from same target home directory\"\n\n\
         pkill -f \"$TARGET_HOME\"\n\necho \"Cleaning up the Target home directory.\"\nif [ \"$TARGET\
         _HOME\" != \"\" ] \nthen\n    echo \"TARGET_HOME specified\"\n    rm -rf $TARGET_HOME\nelse\n\
         \    echo \"TARGET_HOME need to be specified\"\n    exit 1\nfi\n"
   itemType: Script
   nodeSet: 
   properties: 
   -  name: $TARGET_HOME
      defaultValue: /tmp/tomcat
      description: '<i style="color: #A8A8A8;">Specify the target folder where the Tomcat Server needs
         to be installed.</i>'
      multiSelect: 
      required: false
      shared: true
      type: Text
-  name: Tomcat Binary Download Step
   item: !ScriptItem
      description: "In this step, the tomcat binary is downloaded using wget or curl based on which u\
         tlity is available. \n\nOnce the download is successfull, the binary is unzipped to the TARG\
         ET_HOME folder.\n\nThe shell scripts are given execute permissions to enable to start tomcat\
         \ server."
      fileName: 
      invokingProgram: 
      language: Shell
      script: |-
         if hash wget 2>/dev/null; then
             echo "wget command is present"
             wget --directory-prefix=$TARGET_HOME http://archive.apache.org/dist/tomcat/tomcat-8/v8.0.22/bin/apache-tomcat-8.0.22.tar.gz
         else
             if hash curl 2>/dev/null; then
                 echo "curl command is present"
                 curl -o $TARGET_HOME/apache-tomcat-8.0.22.zip http://archive.apache.org/dist/tomcat/tomcat-8/v8.0.22/bin/apache-tomcat-8.0.22.tar.gz
             else
                 echo "Neither wget nor curl command is installed on this instance. Please install one of the packages before moving forward with this run book."
                 exit 1
             fi
         fi

         unzip $TARGET_HOME/apache-tomcat-8.0.22.zip -d $TARGET_HOME
         chmod +rwx $TARGET_HOME/apache-tomcat-8.0.22/bin/*.sh
   itemType: Script
   nodeSet: 
   properties: []
-  name: Java Installation Verification Step
   item: !ScriptItem
      description: This step verifies if the JAVA_HOME is set. If not set, the step exits the execution
         with appropriate message.
      fileName: 
      invokingProgram: 
      language: Shell
      script: "if [ \"$JAVA_HOME\" = \"\" ] \nthen\n    echo \"Need to set JAVA_HOME\"\n    export JA\
         VA_HOME=/usr/bin/java\n    echo $JAVA_HOME\nelse\n    echo $JAVA_HOME\nfi\n\nif [ \"$JAVA_HO\
         ME\" != \"\" ] \nthen\n    echo \"JAVA_HOME is valid\"\nelse\n    echo \"JAVA_HOME need to b\
         e specified\"\n    exit 1\nfi\n\n"
   itemType: Script
-  name: Server Startup Step
   item: !ScriptItem
      description: This steps invoked the tomcat startup script.
      fileName: 
      invokingProgram: 
      language: Shell
      script: |-
         nohup $TARGET_HOME/apache-tomcat-8.0.22/bin/startup.sh &
         cat nohup.out
         sleep 5
   itemType: Script
   nodeSet: 
   properties: []
-  name: Server Connection Verification Step
   item: !ScriptItem
      description: In this step, we make multiple attempt to get the Tomcat Home page. If found, the server
         is considered to be successfully started. In not server startup has failed.
      fileName: 
      invokingProgram: 
      language: Shell
      script: "LIMIT=20\n\nindex=0\nstatus=\"Offline\"\nwhile [ $index -le \"$LIMIT\" ]\ndo\n    inde\
         x=$(($index+1))\n    sleep 1\n    wget -q --spider http://127.0.0.1:8080/\n    if [ $? -eq 0\
         \ ]; then\n        echo \"Online\"\n        status=\"Online\"\n        break\n    else\n    \
         \    echo \"Offline\"\n    fi\ndone\n\nif [ $status = \"Offline\" ]\nthen\n    echo \"Tomcat\
         \ Server startup verification failed.\"\n    exit 1\nelse \n    echo \"Tomcat server verific\
         ation successfull.\"\nfi"
   itemType: Script
summary: This is a simple run book for installing tomcat version 8 on any linux environments.
version: 1.0
