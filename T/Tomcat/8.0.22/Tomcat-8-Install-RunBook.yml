!RunBook
authors: Divine Cloud Team
description: This run book installs Apache Tomcat version 8.0.22 on linux environments.
hardwareRequirements: Minimum memory of 512 MB or more.
name: Tomcat 8 Linux Install RunBook
preRequisite: |-
  Following software need to be already installed on the machine before executing this run book:
  <ul>
  <li>Java 6 or higher</li>
  <li>JAVA_HOME should be set</li>
  <li>yum or apt-get package manager</li>
  <li>wget utility for downloading tomcat binaries.</li>
  </ul>
steps:
- item: !ScriptItem
    description: This step verifies if the provided target location has any files in it. If it does, it deletes those file, for a clean installation of tomcat server.
    language: Shell
    reboot: false
    script: |-
      echo "Stopping the existing tomcat process if running from same target home directory"

      pkill -f "$TARGET_HOME"

      echo "Cleaning up the Target home directory."
      if [ "$TARGET_HOME" != "" ]
      then
          echo "TARGET_HOME specified"
          rm -rf $TARGET_HOME
      else
          echo "TARGET_HOME need to be specified"
          exit 1
      fi
  itemType: Script
  name: Existing Tomcat Server Cleanup
  properties:
  - defaultValue: /tmp/tomcat
    description: '<i style="color: #A8A8A8;">Specify the target folder where the Tomcat
      Server needs to be installed.</i>'
    multiSelect: ''
    name: $TARGET_HOME
    required: false
    shared: true
    type: Text
  reboot: false
- item: !ScriptItem
    description: |-
      In this step, the tomcat binary is downloaded using wget or curl based on which utlity is available.

      Once the download is successfull, the binary is unzipped to the TARGET_HOME folder.

      The shell scripts are given execute permissions to enable to start tomcat server.
    language: Shell
    reboot: false
    script: |-
      if hash wget 2>/dev/null; then
        echo "wget command is present"
        wget --directory-prefix=$TARGET_HOME http://archive.apache.org/dist/tomcat/tomcat-8/v8.0.22/bin/apache-tomcat-8.0.22.tar.gz
      else
        if hash curl 2>/dev/null; then
          echo "curl command is present"
          curl -o $TARGET_HOME/apache-tomcat-8.0.22.tar.gz http://archive.apache.org/dist/tomcat/tomcat-8/v8.0.22/bin/apache-tomcat-8.0.22.tar.gz
        else
          echo "Neither wget nor curl command installed on this instance. Please install one of these two packages before moving forward with this runbook."
          exit 1
        fi
      fi

      cd $TARGET_HOME
      tar -xvf $TARGET_HOME/apache-tomcat-8.0.22.tar.gz
      chmod +rwx $TARGET_HOME/apache-tomcat-8.0.22/bin/*.sh
  itemType: Script
  name: Tomcat Binary Download Step
  reboot: false
- item: !ScriptItem
    description: This step verifies if the JAVA_HOME is set. If not set, the step exits the execution with appropriate message.
    language: Shell
    reboot: false
    script: |
      if [ "$JAVA_HOME" = "" ]
      then
          echo "Need to set JAVA_HOME"
          export JAVA_HOME=/usr/bin/java
          echo $JAVA_HOME
      else
          echo $JAVA_HOME
      fi

      if [ "$JAVA_HOME" != "" ]
      then
          echo "JAVA_HOME is valid"
      else
          echo "JAVA_HOME need to be specified"
          exit 1
      fi
  itemType: Script
  name: Java Installation Verification Step
  reboot: false
- item: !ScriptItem
    description: This steps invoked the tomcat startup script.
    language: Shell
    reboot: false
    script: |-
      nohup $TARGET_HOME/apache-tomcat-8.0.22/bin/startup.sh &
      cat nohup.out
      sleep 5
  itemType: Script
  name: Server Startup Step
  reboot: false
- item: !ScriptItem
    description: In this step, we make multiple attempt to get the Tomcat Home page. If found, the server is considered to be successfully started. In not server startup has failed.
    language: Shell
    reboot: false
    script: |
      LIMIT=20

      index=0
      status="Offline"
      while [ $index -le "$LIMIT" ]
      do
          index=$(($index+1))
          sleep 1
          wget -q --spider http://127.0.0.1:8080/
          if [ $? -eq 0 ]; then
              echo "Online"
              status="Online"
              break
          else
              echo "Offline"
          fi
      done

      if [ $status = "Offline" ]
      then
          echo "Tomcat Server startup verification failed."
          exit 1
      else
          echo "Tomcat server verification successfull."
      fi
  itemType: Script
  name: Server Connection Verification Step
  reboot: false
summary: This is a simple run book for installing tomcat version 8 on any linux environments.
version: '1.0'
